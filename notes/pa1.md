# PA1 必答题

## 1. 程序是个状态机

<figure>
  <svg version="1.1" viewBox="-.5 -.5 422 79" xmlns="http://www.w3.org/2000/svg">
    <g stroke="#000">
      <path d="m40 57h20-10 13.63" fill="none" pointer-events="stroke" stroke-miterlimit="10"/>
      <path d="m68.88 57-7 3.5 1.75-3.5-1.75-3.5z" pointer-events="all" stroke-miterlimit="10"/>
      <path d="m40 57a20 20 0 0 1-20 20 20 20 0 0 1-20-20 20 20 0 0 1 20-20 20 20 0 0 1 20 20z" fill="#fff"/>
    </g>
    <g font-family="Times New Roman" font-size="15px" text-anchor="middle">
      <path d="m16.292 58.093q0-1.6992 0.5127-2.9224 0.5127-1.2305 1.3623-1.8311 0.65918-0.47607 1.3623-0.47607 1.1426 0 2.0508 1.1646 1.1353 1.4429 1.1353 3.9111 0 1.7285-0.49805 2.937-0.49805 1.2085-1.2744 1.7578-0.76904 0.54199-1.4868 0.54199-1.4209 0-2.3657-1.6772-0.79834-1.4136-0.79834-3.4058zm1.4355 0.18311q0 2.0508 0.50537 3.3472 0.41748 1.0913 1.2451 1.0913 0.39551 0 0.82031-0.35156 0.4248-0.35889 0.64453-1.1938 0.33691-1.2598 0.33691-3.5522 0-1.6992-0.35156-2.8345-0.26367-0.84229-0.68115-1.1938-0.30029-0.2417-0.7251-0.2417-0.49805 0-0.88623 0.44678-0.52734 0.60791-0.71777 1.9116-0.19043 1.3037-0.19043 2.5708z" aria-label="0"/>
    </g>
    <g stroke="#000">
      <path d="m110 57h20-10 13.63" fill="none" pointer-events="stroke" stroke-miterlimit="10"/>
      <path d="m138.88 57-7 3.5 1.75-3.5-1.75-3.5z" pointer-events="all" stroke-miterlimit="10"/>
      <path d="m110 57a20 20 0 0 1-20 20 20 20 0 0 1-20-20 20 20 0 0 1 20-20 20 20 0 0 1 20 20z" fill="#fff"/>
    </g>
    <g font-family="Times New Roman" font-size="15px" text-anchor="middle">
      <path d="m87.508 54.042 2.417-1.1792h0.2417v8.3862q0 0.83496 0.06592 1.04 0.07324 0.20508 0.29297 0.31494 0.21973 0.10986 0.89355 0.12451v0.271h-3.7354v-0.271q0.70312-0.01465 0.9082-0.11719 0.20508-0.10986 0.28564-0.28564 0.08057-0.18311 0.08057-1.0767v-5.3613q0-1.084-0.07324-1.3916-0.05127-0.23438-0.19043-0.34424-0.13184-0.10986-0.32227-0.10986-0.271 0-0.75439 0.22705z" aria-label="1"/>
    </g>
    <g stroke="#000">
      <path d="m180 57h20-10 13.63" fill="none" pointer-events="stroke" stroke-miterlimit="10"/>
      <path d="m208.88 57-7 3.5 1.75-3.5-1.75-3.5z" pointer-events="all" stroke-miterlimit="10"/>
      <path d="m180 57a20 20 0 0 1-20 20 20 20 0 0 1-20-20 20 20 0 0 1 20-20 20 20 0 0 1 20 20z" fill="#fff"/>
    </g>
    <g font-family="Times New Roman" font-size="15px" text-anchor="middle">
      <path d="m162.63 61.088-0.6958 1.9116h-5.8594v-0.271q2.5854-2.3584 3.6401-3.8525 1.0547-1.4941 1.0547-2.7319 0-0.94482-0.57861-1.5527-0.57862-0.60791-1.3843-0.60791-0.73242 0-1.3184 0.43213-0.57861 0.4248-0.85693 1.2524h-0.271q0.18311-1.355 0.9375-2.0801 0.76172-0.7251 1.897-0.7251 1.2085 0 2.0142 0.77637 0.81299 0.77637 0.81299 1.8311 0 0.7544-0.35156 1.5088-0.54199 1.1865-1.7578 2.5122-1.8237 1.9922-2.2778 2.4023h2.5928q0.79101 0 1.106-0.05859 0.32227-0.05859 0.57862-0.23438 0.25635-0.1831 0.44678-0.5127z" aria-label="2"/>
    </g>
    <g stroke="#000">
      <path d="m250 57h20-10 13.63" fill="none" pointer-events="stroke" stroke-miterlimit="10"/>
      <path d="m278.88 57-7 3.5 1.75-3.5-1.75-3.5z" pointer-events="all" stroke-miterlimit="10"/>
      <path d="m250 57a20 20 0 0 1-20 20 20 20 0 0 1-20-20 20 20 0 0 1 20-20 20 20 0 0 1 20 20z" fill="#fff"/>
    </g>
    <g font-family="Times New Roman" font-size="15px" text-anchor="middle">
      <path d="m226.51 54.958q0.4248-1.0034 1.0693-1.5454 0.65186-0.54932 1.6187-0.54932 1.1938 0 1.831 0.77637 0.4834 0.57861 0.4834 1.2378 0 1.084-1.3623 2.2412 0.91552 0.35889 1.3843 1.0254t0.46875 1.5674q0 1.2891-0.82031 2.2339-1.0693 1.2305-3.0981 1.2305-1.0034 0-1.3696-0.24902-0.35889-0.24902-0.35889-0.53467 0-0.2124 0.16846-0.37354 0.17578-0.16113 0.41748-0.16113 0.1831 0 0.37353 0.05859 0.12451 0.03662 0.56397 0.271 0.43945 0.22705 0.60791 0.271 0.27099 0.08057 0.57861 0.08057 0.74707 0 1.2964-0.57861 0.55664-0.57861 0.55664-1.3696 0-0.57861-0.25635-1.1279-0.19043-0.41016-0.41748-0.62256-0.31494-0.29297-0.86426-0.52734-0.54931-0.2417-1.1206-0.2417h-0.23438v-0.21973q0.57862-0.07324 1.1572-0.41748 0.58594-0.34424 0.84961-0.82764t0.26367-1.062q0-0.75439-0.47607-1.2158-0.46875-0.46875-1.1719-0.46875-1.1352 0-1.897 1.2158z" aria-label="3"/>
    </g>
    <g stroke="#000">
      <path d="m320 57h53.63" fill="none" pointer-events="stroke" stroke-miterlimit="10"/>
      <path d="m378.88 57-7 3.5 1.75-3.5-1.75-3.5z" pointer-events="all" stroke-miterlimit="10"/>
      <path d="m320 57a20 20 0 0 1-20 20 20 20 0 0 1-20-20 20 20 0 0 1 20-20 20 20 0 0 1 20 20z" fill="#fff"/>
    </g>
    <g font-family="Times New Roman" font-size="15px" text-anchor="middle">
      <path d="m302.73 59.338v1.04h-1.333v2.6221h-1.2085v-2.6221h-4.2041v-0.9375l4.6069-6.5771h0.80566v6.4746zm-2.5415 0v-4.9292l-3.4863 4.9292z" aria-label="4"/>
    </g>
    <path d="m420 57a20 20 0 0 1-20 20 20 20 0 0 1-20-20 20 20 0 0 1 20-20 20 20 0 0 1 20 20z" fill="#fff" stroke="#000"/>
    <path d="m416 57a16 16 0 0 1-16 16 16 16 0 0 1-16-16 16 16 0 0 1 16-16 16 16 0 0 1 16 16z" fill="none" stroke="#000"/>
    <g font-family="Times New Roman" font-size="15px" text-anchor="middle">
      <path d="m402.26 53.068-0.57129 1.2451h-2.9883l-0.65186 1.333q1.9409 0.28564 3.0762 1.4429 0.97412 0.99609 0.97412 2.3438 0 0.78369-0.32227 1.4502-0.31494 0.6665-0.79834 1.1353t-1.0767 0.75439q-0.84228 0.40283-1.7285 0.40283-0.89356 0-1.3037-0.30029-0.40284-0.30762-0.40284-0.67383 0-0.20508 0.16846-0.35889 0.16846-0.16113 0.42481-0.16113 0.19042 0 0.32958 0.05859 0.14649 0.05859 0.49073 0.30029 0.54931 0.38086 1.1133 0.38086 0.85693 0 1.5015-0.64453 0.65186-0.65186 0.65186-1.582 0-0.90088-0.57861-1.6772-0.57862-0.78369-1.5967-1.2085-0.79834-0.32959-2.1753-0.38086l1.9043-3.8599z" aria-label="5"/>
    </g>
    <g stroke="#000" stroke-miterlimit="10">
      <path d="m20 7v23.63" fill="none" pointer-events="stroke"/>
      <path d="m20 35.88-3.5-7 3.5 1.75 3.5-1.75z" pointer-events="all"/>
      <path d="m285.86 42.86q-55.86-55.86-107.22-4.5" fill="none" pointer-events="stroke"/>
      <path d="m174.93 42.07 2.48-7.43 1.23 3.72 3.72 1.23z" pointer-events="all"/>
    </g>
    <path d="m270 17h50v10h-50z" fill="none"/>
    <g font-family="Verdana" font-size="10px" text-anchor="middle">
      <path d="m276.35 21.047h-0.0488q-0.20508-0.04883-0.40039-0.06836-0.19043-0.02441-0.4541-0.02441-0.42481 0-0.82032 0.19043-0.3955 0.18555-0.76172 0.4834v3.8721h-0.91796v-5.4541h0.91796v0.80566q0.54688-0.43945 0.96192-0.62012 0.41992-0.18555 0.85449-0.18555 0.23926 0 0.34668 0.01465 0.10742 0.0098 0.32227 0.04395zm5.6689 4.4531h-4.9219v-1.0205q0.51269-0.43945 1.0254-0.87891 0.51757-0.43945 0.96191-0.87402 0.9375-0.9082 1.2842-1.4404 0.34668-0.53711 0.34668-1.1572 0-0.56641-0.37598-0.88379-0.37109-0.32226-1.04-0.32226-0.44433 0-0.96191 0.15625t-1.0107 0.47852h-0.0488v-1.0254q0.34668-0.1709 0.92285-0.3125 0.58106-0.1416 1.123-0.1416 1.1182 0 1.7529 0.54199 0.63476 0.53711 0.63476 1.46 0 0.41504-0.10742 0.77637-0.10254 0.35645-0.30762 0.67871-0.19042 0.30274-0.44921 0.5957-0.25391 0.29297-0.62012 0.64941-0.52246 0.5127-1.0791 0.99609-0.55664 0.47852-1.04 0.88867h3.9111zm11.04-0.37598-5.6348-2.5049v-0.60547l5.6348-2.5049v0.87891l-4.4434 1.9287 4.4434 1.9287zm10.117 0.37598h-3.9356v-0.74219h1.5137v-4.873h-1.5137v-0.66406q0.30762 0 0.65918-0.04883 0.35156-0.05371 0.53223-0.15137 0.22461-0.12207 0.35156-0.30762 0.13184-0.19043 0.15137-0.50781h0.75683v6.5527h1.4844zm6.7627-3.6377q0 1.958-0.61523 2.876-0.61035 0.91309-1.8994 0.91309-1.3086 0-1.9141-0.92773-0.60058-0.92774-0.60058-2.8516 0-1.9385 0.61035-2.8613 0.61035-0.92773 1.9043-0.92773 1.3086 0 1.9092 0.94238 0.60547 0.9375 0.60547 2.8369zm-1.2842 2.2168q0.1709-0.39551 0.2295-0.92774 0.0635-0.53711 0.0635-1.2891 0-0.74219-0.0635-1.2891-0.0586-0.54688-0.23438-0.92773-0.1709-0.37598-0.46875-0.56641-0.29297-0.19043-0.75684-0.19043-0.45898 0-0.76171 0.19043-0.29786 0.19043-0.47364 0.57617-0.16601 0.36133-0.22949 0.94238-0.0586 0.58106-0.0586 1.2744 0 0.76172 0.0537 1.2744 0.0537 0.5127 0.22949 0.91797 0.16113 0.38086 0.4541 0.58106 0.29785 0.2002 0.78613 0.2002 0.45899 0 0.76172-0.19043 0.30274-0.19043 0.46875-0.57617zm7.6416-2.2168q0 1.958-0.61523 2.876-0.61035 0.91309-1.8994 0.91309-1.3086 0-1.9141-0.92773-0.60058-0.92774-0.60058-2.8516 0-1.9385 0.61035-2.8613 0.61035-0.92773 1.9043-0.92773 1.3086 0 1.9092 0.94238 0.60546 0.9375 0.60546 2.8369zm-1.2842 2.2168q0.17089-0.39551 0.22949-0.92774 0.0635-0.53711 0.0635-1.2891 0-0.74219-0.0635-1.2891-0.0586-0.54688-0.23438-0.92773-0.1709-0.37598-0.46875-0.56641-0.29297-0.19043-0.75683-0.19043-0.45899 0-0.76172 0.19043-0.29785 0.19043-0.47364 0.57617-0.16601 0.36133-0.22949 0.94238-0.0586 0.58106-0.0586 1.2744 0 0.76172 0.0537 1.2744 0.0537 0.5127 0.22949 0.91797 0.16113 0.38086 0.4541 0.58106 0.29786 0.2002 0.78614 0.2002 0.45898 0 0.76172-0.19043 0.30273-0.19043 0.46875-0.57617z" aria-label="r2 &lt; 100"/>
    </g>
    <path d="m320 67h60v10h-60z" fill="none"/>
    <g font-family="Verdana" font-size="10px" text-anchor="middle">
      <path d="m327.26 71.047h-0.0488q-0.20508-0.04883-0.40039-0.06836-0.19043-0.02441-0.4541-0.02441-0.42481 0-0.82031 0.19043-0.39551 0.18555-0.76172 0.4834v3.8721h-0.91797v-5.4541h0.91797v0.80566q0.54687-0.43945 0.96191-0.62012 0.41992-0.18555 0.85449-0.18555 0.23926 0 0.34668 0.01465 0.10743 0.0098 0.32227 0.04394zm5.6689 4.4531h-4.9219v-1.0205q0.51269-0.43945 1.0254-0.87891 0.51758-0.43945 0.96191-0.87402 0.9375-0.9082 1.2842-1.4404 0.34668-0.53711 0.34668-1.1572 0-0.56641-0.37597-0.88379-0.3711-0.32226-1.04-0.32226-0.44434 0-0.96192 0.15625-0.51757 0.15625-1.0107 0.47852h-0.0488v-1.0254q0.34668-0.1709 0.92285-0.3125 0.58106-0.1416 1.123-0.1416 1.1182 0 1.7529 0.54199 0.63477 0.53711 0.63477 1.46 0 0.41504-0.10742 0.77637-0.10254 0.35645-0.30762 0.67871-0.19043 0.30274-0.44922 0.5957-0.25391 0.29297-0.62012 0.64941-0.52246 0.5127-1.0791 0.99609-0.55664 0.47852-1.04 0.88867h3.9111zm11.108-2.8809-5.6348 2.5049v-0.87891l4.4434-1.9287-4.4434-1.9287v-0.87891l5.6348 2.5049zm8.2275-0.9375h-5.791v-0.78125h5.791zm0 2.0508h-5.791v-0.78125h5.791zm10.005 1.7676h-3.9355v-0.74219h1.5137v-4.873h-1.5137v-0.66406q0.30761 0 0.65918-0.04883 0.35156-0.05371 0.53222-0.15137 0.22461-0.12207 0.35157-0.30762 0.13183-0.19043 0.15136-0.50781h0.75684v6.5527h1.4844zm6.7627-3.6377q0 1.958-0.61523 2.876-0.61036 0.91309-1.8994 0.91309-1.3086 0-1.9141-0.92773-0.60059-0.92774-0.60059-2.8516 0-1.9385 0.61035-2.8613 0.61036-0.92773 1.9043-0.92773 1.3086 0 1.9092 0.94238 0.60547 0.9375 0.60547 2.8369zm-1.2842 2.2168q0.1709-0.39551 0.22949-0.92774 0.0635-0.53711 0.0635-1.2891 0-0.74219-0.0635-1.2891-0.0586-0.54688-0.23437-0.92773-0.1709-0.37598-0.46875-0.56641-0.29297-0.19043-0.75684-0.19043-0.45898 0-0.76172 0.19043-0.29785 0.19043-0.47363 0.57617-0.16602 0.36133-0.22949 0.94238-0.0586 0.58106-0.0586 1.2744 0 0.76172 0.0537 1.2744 0.0537 0.5127 0.2295 0.91797 0.16113 0.38086 0.4541 0.58106 0.29785 0.2002 0.78613 0.2002 0.45899 0 0.76172-0.19043 0.30273-0.19043 0.46875-0.57617zm7.6416-2.2168q0 1.958-0.61523 2.876-0.61035 0.91309-1.8994 0.91309-1.3086 0-1.9141-0.92773-0.60059-0.92774-0.60059-2.8516 0-1.9385 0.61036-2.8613 0.61035-0.92773 1.9043-0.92773 1.3086 0 1.9092 0.94238 0.60547 0.9375 0.60547 2.8369zm-1.2842 2.2168q0.1709-0.39551 0.22949-0.92774 0.0635-0.53711 0.0635-1.2891 0-0.74219-0.0635-1.2891-0.0586-0.54688-0.23437-0.92773-0.1709-0.37598-0.46875-0.56641-0.29297-0.19043-0.75684-0.19043-0.45898 0-0.76172 0.19043-0.29785 0.19043-0.47363 0.57617-0.16601 0.36133-0.22949 0.94238-0.0586 0.58106-0.0586 1.2744 0 0.76172 0.0537 1.2744 0.0537 0.5127 0.22949 0.91797 0.16113 0.38086 0.4541 0.58106 0.29785 0.2002 0.78613 0.2002 0.45899 0 0.76172-0.19043 0.30274-0.19043 0.46875-0.57617z" aria-label="r2 &gt;= 100"/>
    </g>
  </svg>
</figure>

上述DFA中的状态标号为PC.

## 2. 理解基础设施

**不使用SDB:** $500 \times 90\% \times 30\mathrm{s} \times 20 = 270000\mathrm{s} = 75\mathrm{h}.$

**使用SDB**:** $500 \times 90\% \times 10\mathrm{s} \times 20 = 90000\mathrm{s} = 25\mathrm{h}.$

## 3. RTFM (1)

**指令格式:**

* `R`: inter-register ops
* `I`: short imm; loads
  * 变体1: imm编码CSR与立即数, 如`csrXi`
  * 变体2: 移位操作, imm处编码移位量
* `S`: stores
* `B`: conditional branches
* `U`: long imm
* `J`: unconditional branches

**`lui`:** `x[rd] <- SEXT(imm << 12)`

**`mstatus`:** 见下.

```c
typedef union CsrMstatus_ {
  struct {
    word_t resv_0 : 1;
    word_t sie : 1;
    word_t resv_1 : 1;
    word_t mie : 1;
    word_t resv_2 : 1;
    word_t spie : 1;
    word_t resv_3 : 1;
    word_t mpie : 1;
    word_t spp : 1;
    word_t resv_4 : 2;
    word_t mpp : 2;
    word_t fs : 2;
    word_t xs : 2;
    word_t mprv : 1;
    word_t sum : 1;
    word_t mxr : 1;
    word_t tvm : 1;
    word_t tw : 1;
    word_t tsr : 1;
#ifdef CONFIG_RV64
    word_t resv_5 : 40; // XLEN - 24
#else
    word_t resv_5 : 8; // XLEN - 24
#endif
    word_t sd : 1;
  };
  word_t packed;
} CsrMstatus_t;
```

## 4. shell命令

统计`nemu/`目录下所有`.c`和`.h`文件的非空行数总和:

```bash
find $NEMU_HOME -type f -regex '^.+\.\(c\|h\)$' -print | xargs grep -c -e '^.\+$' | cut -f 2 -d ':' | awk '{ sum += $1 }; END { print sum }'
```

若要统计所有行数, 包括空行, 只需要将grep的regex改为`'^.*$'`即可, 即:

```bash
find $NEMU_HOME -type f -regex '^.+\.\(c\|h\)$' -print | xargs grep -c -e '^.*$' | cut -f 2 -d ':' | awk '{ sum += $1 }; END { print sum }'
```

## 5. RTFM (2)

* `-Wall`: 开启更多警告. <https://gcc.gnu.org/onlinedocs/gcc/Warning-Options.html#index-Wall>
* `-Werror`: 将警告视为错误. <https://gcc.gnu.org/onlinedocs/gcc/Warning-Options.html#index-Werror>

**目的:** 使用编译器的启发式规则在编译器发现部分明显的问题.